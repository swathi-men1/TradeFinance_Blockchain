<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="trade.css">

    <!-- ✅ Extra styles ONLY for Avg Risk card -->
    <style>
        .avg-risk-card {
            background: #1e2a38;   /* dark blue (matches theme) */
            text-align: center;
        }

        .avg-risk-card .score {
            font-size: 36px;
            font-weight: bold;
            color: #ffffff;
        }

        .avg-risk-card .level {
            font-size: 18px;
            font-weight: bold;
            margin-top: 5px;
        }
    </style>
</head>
<body>

<!-- Welcome Section -->
<div class="welcome-section">
    <h1>Welcome to ChainDocs!</h1>
    <p>Trade & Document Integrity Dashboard</p>
</div>

<!-- Dashboard Cards -->
<div class="cards">

    <div class="card">
        <h3>Total Trades</h3>
        <p id="totalTrades">0</p>
    </div>

    <div class="card">
        <h3>Pending Documents</h3>
        <p id="pendingDocs">0</p>
    </div>

    <div class="card">
        <h3>Completed Trades</h3>
        <p id="completedTrades">0</p>
    </div>

    <div class="card">
        <h3>Active Users</h3>
        <p id="activeUsers">0</p>
    </div>

    <div class="card">
        <h3>Tamper Attempts</h3>
        <p id="tamperCount">0</p>
    </div>

    <!-- ✅ Avg Risk Card -->
    <div class="card avg-risk-card">
        <h3>Avg Risk Score</h3>
        <div class="score" id="avgRisk">0</div>
        <div class="level" id="avgRiskLevel">LOW</div>
    </div>

</div>

<!-- Recent Trades -->
<h2>Recent Trades</h2>
<table class="trades-table" id="recentTrades">
    <thead>
        <tr>
            <th>Trade ID</th>
            <th>Seller</th>
            <th>Status</th>
            <th>Risk</th>
            <th>Date</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
async function loadDashboard() {
    try {
        const trades = await (await fetch("http://127.0.0.1:8000/trades")).json();
        const risks = await (await fetch("http://127.0.0.1:8000/risks")).json();
        const analytics = await (await fetch("http://127.0.0.1:8000/analytics")).json();

        // ---- Cards (FIXED) ----
        document.getElementById("totalTrades").innerText = trades.length;

        document.getElementById("completedTrades").innerText =
            trades.filter(t => t.status === "Uploaded").length;

        document.getElementById("pendingDocs").innerText =
            trades.filter(t => t.status !== "Uploaded").length;

        document.getElementById("activeUsers").innerText =
            analytics.active_users;

        document.getElementById("tamperCount").innerText =
            analytics.tamper_attempts;

        // ---- Avg Risk ----
        let totalRisk = 0;
        risks.forEach(r => totalRisk += r.risk_score);

        const avgRisk = risks.length ? Math.round(totalRisk / risks.length) : 0;

        const avgRiskEl = document.getElementById("avgRisk");
        const avgRiskLevelEl = document.getElementById("avgRiskLevel");

        avgRiskEl.innerText = avgRisk;

        if (avgRisk < 30) {
            avgRiskLevelEl.innerText = "LOW";
            avgRiskLevelEl.style.color = "#4CAF50";
        } else if (avgRisk < 60) {
            avgRiskLevelEl.innerText = "MEDIUM";
            avgRiskLevelEl.style.color = "#FFC107";
        } else {
            avgRiskLevelEl.innerText = "HIGH";
            avgRiskLevelEl.style.color = "#F44336";
        }

        // ---- Recent Trades (NOW IT WILL RUN) ----
        const tbody = document.querySelector("#recentTrades tbody");
        tbody.innerHTML = "";

        if (trades.length === 0) {
            tbody.innerHTML =
                `<tr><td colspan="5" style="text-align:center;">No trades found</td></tr>`;
            return;
        }

        trades.slice(-5).reverse().forEach(t => {
            const row = tbody.insertRow();

            row.insertCell().innerText = t.trade_id;
            row.insertCell().innerText = t.seller;

            const statusCell = row.insertCell();
            statusCell.innerText = t.status;
            statusCell.style.color =
                t.status === "Uploaded" ? "green" : "red";

            const riskCell = row.insertCell();
            const risk = risks.find(r => r.trade_id === t.trade_id);

            if (risk) {
                riskCell.innerText = risk.risk_level;
                riskCell.style.color =
                    risk.risk_level === "LOW" ? "green" :
                    risk.risk_level === "MEDIUM" ? "orange" : "red";
            } else {
                riskCell.innerText = "N/A";
            }

            row.insertCell().innerText = t.created_at;
        });

    } catch (err) {
        console.error("Dashboard error:", err);
    }
}

window.onload = loadDashboard;
</script>


</body>
</html>
