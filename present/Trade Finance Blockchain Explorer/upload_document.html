<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Upload Documents</title>
<meta name="viewport" content="width=device-width initial-scale=1.0">
<link rel="stylesheet" href="trade.css">
</head>
<body>

<div class="corp-layout">

    <!-- SIDEBAR -->
    <div class="corp-sidebar">
        <h2 class="logo">ChainDocs</h2>
        <a id="nav-upload" href="upload_document.html">Upload Documents</a>
        <a id="nav-risk" href="risk.html">Risk Dashboard</a>
        <button class="logout-btn" onclick="openLogoutModal()">Logout</button>
    </div>

    <!-- MAIN CONTENT -->
    <div class="corp-main">

        <div class="form-section">
            <h1>Upload Required Documents</h1>

            <form id="uploadForm">

                <label>Trade ID</label>
                <input type="number" id="tradeId" placeholder="Enter Trade ID" required>

                <label>Document Type</label>
                <select id="docType" required>
                    <option value="">Select document type</option>
                    <option value="Invoice">Invoice</option>
                    <option value="Contract">Contract</option>
                    <option value="Shipping Document">Shipping Document</option>
                </select>

                <label>Upload Document</label>
                <input type="file" id="docFile" accept=".pdf,.doc,.docx" required>

                <label>Document Hash (Generated by Backend)</label>
                <input type="text" id="docHash" readonly>

                <button type="submit">Upload</button>

                <p class="success-message" id="successMsg"></p>
                <p id="verifyMsg" style="font-weight:bold;"></p>

            </form>
        </div>

    </div>
</div>
<!-- LOGOUT MODAL -->
<div id="logoutModal" class="modal">
    <div class="modal-content">
        <h3>Confirm Logout</h3>
        <p>Do you really want to logout?</p>
        <div class="modal-buttons">
            <button class="btn-yes" onclick="logoutYes()">Yes</button>
            <button class="btn-no" onclick="logoutNo()">No</button>
        </div>
    </div>
</div>
<!-- ROLE CHECK -->
<script>
const role = localStorage.getItem("role");
const username = localStorage.getItem("username");

if (!role || !username) {
    alert("Login required");
    window.location.href = "login.html";
}

if (role !== "corporate") {
    alert("Only Corporate users can upload documents");
    window.location.href = "login.html";
}
</script>

<!-- UPLOAD + VERIFY LOGIC -->
<script>
document.getElementById("uploadForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const tradeId = document.getElementById("tradeId").value;
    const docType = document.getElementById("docType").value;
    const fileInput = document.getElementById("docFile");
    const docHash = document.getElementById("docHash");
    const successMsg = document.getElementById("successMsg");
    const verifyMsg = document.getElementById("verifyMsg");

    if (!fileInput.files.length) {
        alert("Please select a file");
        return;
    }

    const formData = new FormData();
    formData.append("trade_id", tradeId);
    formData.append("doc_type", docType);
    formData.append("file", fileInput.files[0]);

    try {
        const response = await fetch("http://127.0.0.1:8000/upload-document", {
            method: "POST",
            headers: {
                "X-User": username
            },
            body: formData
        });

        const data = await response.json();

        if (!response.ok) {
            alert(data.detail || "Upload failed");
            return;
        }

        // âœ… SHOW HASH
        docHash.value = data.hash;
        successMsg.style.color = "green";
        successMsg.innerText = "Document uploaded successfully âœ…";

        // âœ… CALL VERIFY AFTER UPLOAD
        const verifyRes = await fetch(
            `http://127.0.0.1:8000/verify-document/${tradeId}`
        );

        const verifyData = await verifyRes.json();

        verifyMsg.innerText = "Document Status: " + verifyData.status;
        verifyMsg.style.color =
            verifyData.status === "TAMPERED" ? "red" : "green";
        // ðŸ§¹ Clear form after short delay (UX improvement)
        setTimeout(() => {
        document.getElementById("docType").value = "";
        document.getElementById("docFile").value = "";
        document.getElementById("docHash").value = "";

            successMsg.innerText = "";
            verifyMsg.innerText = "";
        }, 2500);
    } catch (err) {
        alert("Upload failed. Check backend.");
        console.error(err);
    }
});
</script>
<script>
const path = window.location.pathname;

document.querySelectorAll(".corp-sidebar a").forEach(link => {
    link.classList.remove("active");
});

if (path.includes("upload_document")) {
    document.getElementById("nav-upload").classList.add("active");
}
else if (path.includes("risk")) {
    document.getElementById("nav-risk").classList.add("active");
}
</script>

<script>
function openLogoutModal() {
    document.getElementById("logoutModal").style.display = "block";
}

function logoutYes() {
    localStorage.clear();
    window.location.href = "login.html";
}

function logoutNo() {
    document.getElementById("logoutModal").style.display = "none";
}
</script>
</body>
</html>