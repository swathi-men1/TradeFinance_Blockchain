<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Corporate Dashboard | Trade Finance</title>

    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #f4f6f9;
      }

      header {
        background: #1a202c;
        color: white;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      header .left {
        display: flex;
        gap: 20px;
        align-items: center;
      }

      header h2 {
        margin: 0;
      }

      header a {
        color: #cbd5e0;
        text-decoration: none;
        font-weight: bold;
        cursor: pointer;
      }

      header a:hover {
        color: white;
      }

      .logout {
        background: #e53e3e;
        border: none;
        padding: 8px 14px;
        color: white;
        border-radius: 4px;
        cursor: pointer;
      }

      .container {
        padding: 30px;
        max-width: 1000px;
        margin: auto;
      }

      .card {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
      }

      button {
        background: #3182ce;
        color: white;
        border: none;
        padding: 8px 14px;
        border-radius: 4px;
        cursor: pointer;
      }

      button:hover {
        background: #2b6cb0;
      }

      .delete-btn {
        background: #e53e3e;
        margin-left: 8px;
      }

      .delete-btn:hover {
        background: #c53030;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      th,
      td {
        padding: 12px;
        border-bottom: 1px solid #ddd;
        text-align: left;
      }

      th {
        background: #edf2f7;
      }

      .status-pending {
        color: orange;
        font-weight: bold;
      }

      .status-accepted {
        color: green;
        font-weight: bold;
      }

      .status-rejected {
        color: red;
        font-weight: bold;
      }

      .risk-low {
        color: green;
        font-weight: bold;
      }

      .risk-medium {
        color: orange;
        font-weight: bold;
      }

      .risk-high {
        color: red;
        font-weight: bold;
      }

      footer {
        text-align: center;
        padding: 15px;
        font-size: 13px;
        color: #666;
      }

      .note {
        font-size: 13px;
        color: #555;
        background: #f1f5f9;
        padding: 8px 12px;
        border-radius: 4px;
        margin-top: 10px;
      }
    </style>
  </head>

  <body>
    <!-- AUTH CHECK -->
    <script>
      if (localStorage.getItem("role") !== "corporate") {
        window.location.href = "../../login.html";
      }
    </script>

    <!-- HEADER -->
    <header>
      <div class="left">
        <h2>Corporate Dashboard</h2>
        <a onclick="showUpload()">Upload Document</a>
        <a onclick="showMyDocs()">My Documents</a>
      </div>
      <button class="logout" onclick="logout()">Logout</button>
    </header>

    <div class="container">
      <!-- RISK SCORE CARD -->
      <div class="card" id="riskCard">
        <h3>My Risk Score</h3>

        <p><b>Risk Score:</b> <span id="riskScore">-</span></p>
        <p><b>Risk Level:</b> <span id="riskLevel">-</span></p>
        <p><b>Risk Reason:</b> <span id="riskReason">-</span></p>

        <div class="note">
          üìå Risk score is calculated in backend based on document integrity,
          ledger activity, transactions, and external country risk.
        </div>
      </div>

      <!-- UPLOAD SECTION -->
      <div class="card" id="uploadSection">
        <h3>Upload Trade Finance Document</h3>
        <p>üìå Upload Invoice, Bill of Lading, Letter of Credit, etc.</p>

        <input type="file" id="fileInput" />
        <br /><br />
        <button onclick="uploadDocument()">Upload</button>

        <p id="uploadStatus"></p>
      </div>

      <!-- MY DOCUMENTS -->
      <div class="card" id="myDocsSection" style="display: none">
        <h3>My Uploaded Documents</h3>

        <table>
          <thead>
            <tr>
              <th>Document Name</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="docsTable"></tbody>
        </table>
      </div>
    </div>

    <footer>¬© 2026 Trade Finance Demo | Corporate Portal</footer>

    <script>
      const token = localStorage.getItem("token");
      const email = localStorage.getItem("email");

      const uploadSection = document.getElementById("uploadSection");
      const myDocsSection = document.getElementById("myDocsSection");

      function logout() {
        localStorage.clear();
        window.location.href = "../../login.html";
      }

      function showUpload() {
        uploadSection.style.display = "block";
        myDocsSection.style.display = "none";
      }

      function showMyDocs() {
        uploadSection.style.display = "none";
        myDocsSection.style.display = "block";
        loadMyDocuments();
      }

      function getRiskClass(level) {
        if (level === "LOW") return "risk-low";
        if (level === "MEDIUM") return "risk-medium";
        if (level === "HIGH") return "risk-high";
        return "";
      }

      async function loadRiskScore() {
        try {
          if (!email) {
            document.getElementById("riskReason").innerText =
              "Email not found in localStorage (check login.html)";
            return;
          }

          const res = await fetch(
            `http://127.0.0.1:8000/users/${email}/risk-score`,
            {
              headers: { Authorization: "Bearer " + token },
            },
          );

          if (!res.ok) return;

          const data = await res.json();

          document.getElementById("riskScore").innerText =
            data.risk_score ?? "-";

          document.getElementById("riskLevel").innerText =
            data.risk_level ?? "-";

          document.getElementById("riskReason").innerText =
            data.risk_reason ?? "-";

          document.getElementById("riskLevel").className = getRiskClass(
            data.risk_level,
          );
        } catch (err) {
          console.log("Risk Score Fetch Error:", err);
        }
      }

      async function uploadDocument() {
        const fileInput = document.getElementById("fileInput");
        const status = document.getElementById("uploadStatus");

        if (!fileInput.files.length) {
          status.innerText = "Please select a file ‚ùå";
          status.style.color = "red";
          return;
        }

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        status.innerText = "Uploading...";
        status.style.color = "blue";

        const res = await fetch("http://127.0.0.1:8000/upload-document", {
          method: "POST",
          headers: { Authorization: "Bearer " + token },
          body: formData,
        });

        if (res.ok) {
          status.innerText = "Uploaded ‚úî Waiting for verification";
          status.style.color = "green";
          fileInput.value = "";

          loadRiskScore();
          setTimeout(showMyDocs, 800);
        } else {
          const errData = await res.json();
          status.innerText = errData.detail || "Upload failed ‚ùå";
          status.style.color = "red";
        }
      }

      async function loadMyDocuments() {
        try {
          const res = await fetch("http://127.0.0.1:8000/my-documents", {
            headers: { Authorization: "Bearer " + token },
          });

          if (!res.ok) {
            alert("Failed to load documents ‚ùå");
            return;
          }

          const docs = await res.json();
          const table = document.getElementById("docsTable");
          table.innerHTML = "";

          if (docs.length === 0) {
            table.innerHTML =
              "<tr><td colspan='3'>No documents uploaded yet</td></tr>";
            return;
          }

          docs.forEach((doc) => {
            let cls = "status-pending";
            if (doc.status === "ACCEPTED") cls = "status-accepted";
            if (doc.status === "REJECTED") cls = "status-rejected";

            let action = "‚Äî";
            if (doc.status === "PENDING") {
              action = `
                <button class="delete-btn" onclick="deleteDoc(${doc.id})">
                  Delete
                </button>
              `;
            }

            table.innerHTML += `
              <tr>
                <td>${doc.filename}</td>
                <td class="${cls}">${doc.status}</td>
                <td>${action}</td>
              </tr>
            `;
          });
        } catch (err) {
          console.log(err);
          alert("Error loading documents ‚ùå");
        }
      }

      async function deleteDoc(id) {
        if (!confirm("Delete this document?")) return;

        const res = await fetch(`http://127.0.0.1:8000/documents/${id}`, {
          method: "DELETE",
          headers: { Authorization: "Bearer " + token },
        });

        if (res.ok) {
          alert("Document deleted ‚úÖ");
          loadMyDocuments();
          loadRiskScore();
        } else {
          alert("Cannot delete this document ‚ùå");
        }
      }

      // üîÅ AUTO REFRESH (Risk every 15 sec)
      setInterval(() => {
        if (myDocsSection.style.display === "block") {
          loadMyDocuments();
        }
      }, 5000);

      setInterval(() => {
        loadRiskScore();
      }, 15000);

      // initial load
      loadRiskScore();
    </script>
  </body>
</html>
